import { randNorm, sampleByWeights } from "./random";

const hanjaeum: [string, number][] = [
  ["가", 10],
  ["각", 7],
  ["간", 9],
  ["갈", 1],
  ["감", 6],
  ["갑", 1],
  ["강", 8],
  ["개", 8],
  ["객", 1],
  ["갱", 1],
  ["거", 8],
  ["건", 4],
  ["걸", 2],
  ["검", 3],
  ["격", 4],
  ["견", 7],
  ["결", 4],
  ["겸", 2],
  ["경", 19],
  ["계", 16],
  ["고", 14],
  ["곡", 4],
  ["곤", 2],
  ["골", 1],
  ["공", 11],
  ["과", 6],
  ["곽", 1],
  ["관", 9],
  ["광", 4],
  ["괘", 1],
  ["괴", 4],
  ["교", 8],
  ["구", 20],
  ["국", 3],
  ["군", 4],
  ["굴", 1],
  ["궁", 3],
  ["권", 5],
  ["궐", 1],
  ["궤", 1],
  ["귀", 3],
  ["규", 3],
  ["균", 2],
  ["극", 3],
  ["근", 6],
  ["금", 6],
  ["급", 4],
  ["긍", 1],
  ["기", 25],
  ["긴", 1],
  ["길", 1],
  ["나", 1],
  ["낙", 1],
  ["난", 2],
  ["남", 2],
  ["납", 1],
  ["낭", 1],
  ["내", 4],
  ["녀", 1],
  ["년", 1],
  ["념", 1],
  ["녕", 1],
  ["노", 3],
  ["농", 1],
  ["뇌", 2],
  ["능", 1],
  ["니", 1],
  ["다", 2],
  ["단", 11],
  ["달", 1],
  ["담", 3],
  ["답", 3],
  ["당", 5],
  ["대", 8],
  ["덕", 1],
  ["도", 20],
  ["독", 5],
  ["돈", 2],
  ["돌", 1],
  ["동", 8],
  ["두", 3],
  ["둔", 2],
  ["득", 1],
  ["등", 4],
  ["라", 1],
  ["락", 3],
  ["란", 4],
  ["람", 2],
  ["랑", 3],
  ["래", 1],
  ["랭", 1],
  ["략", 2],
  ["량", 7],
  ["려", 4],
  ["력", 3],
  ["련", 7],
  ["렬", 4],
  ["렴", 1],
  ["렵", 1],
  ["령", 5],
  ["례", 3],
  ["로", 5],
  ["록", 4],
  ["론", 1],
  ["롱", 1],
  ["뢰", 2],
  ["료", 3],
  ["룡", 1],
  ["루", 5],
  ["류", 4],
  ["륙", 2],
  ["륜", 2],
  ["률", 3],
  ["륭", 1],
  ["릉", 1],
  ["리", 9],
  ["린", 1],
  ["림", 2],
  ["립", 1],
  ["마", 3],
  ["막", 3],
  ["만", 5],
  ["말", 1],
  ["망", 7],
  ["매", 7],
  ["맥", 2],
  ["맹", 4],
  ["면", 5],
  ["멸", 1],
  ["명", 6],
  ["모", 11],
  ["목", 4],
  ["몰", 1],
  ["몽", 2],
  ["묘", 5],
  ["무", 8],
  ["묵", 2],
  ["문", 4],
  ["물", 2],
  ["미", 8],
  ["민", 3],
  ["밀", 2],
  ["박", 6],
  ["반", 9],
  ["발", 3],
  ["방", 10],
  ["배", 8],
  ["백", 3],
  ["번", 4],
  ["벌", 2],
  ["범", 3],
  ["법", 1],
  ["벽", 2],
  ["변", 4],
  ["별", 1],
  ["병", 5],
  ["보", 7],
  ["복", 8],
  ["본", 1],
  ["봉", 6],
  ["부", 18],
  ["북", 1],
  ["분", 7],
  ["불", 3],
  ["붕", 2],
  ["비", 14],
  ["빈", 3],
  ["빙", 2],
  ["사", 32],
  ["삭", 2],
  ["산", 4],
  ["살", 1],
  ["삼", 1],
  ["상", 20],
  ["새", 1],
  ["색", 2],
  ["생", 1],
  ["서", 12],
  ["석", 7],
  ["선", 10],
  ["설", 4],
  ["섭", 2],
  ["성", 10],
  ["세", 6],
  ["소", 15],
  ["속", 6],
  ["손", 2],
  ["송", 5],
  ["쇄", 2],
  ["쇠", 1],
  ["수", 27],
  ["숙", 6],
  ["순", 8],
  ["술", 3],
  ["숭", 1],
  ["습", 4],
  ["승", 5],
  ["시", 11],
  ["식", 6],
  ["신", 10],
  ["실", 3],
  ["심", 5],
  ["십", 1],
  ["쌍", 1],
  ["씨", 1],
  ["아", 7],
  ["악", 2],
  ["안", 6],
  ["알", 1],
  ["암", 2],
  ["압", 2],
  ["앙", 3],
  ["애", 3],
  ["액", 2],
  ["야", 4],
  ["약", 5],
  ["양", 9],
  ["어", 5],
  ["억", 3],
  ["언", 2],
  ["엄", 1],
  ["업", 1],
  ["여", 7],
  ["역", 8],
  ["연", 12],
  ["열", 3],
  ["염", 3],
  ["엽", 1],
  ["영", 9],
  ["예", 4],
  ["오", 10],
  ["옥", 3],
  ["온", 1],
  ["옹", 2],
  ["와", 2],
  ["완", 2],
  ["왈", 1],
  ["왕", 2],
  ["외", 2],
  ["요", 5],
  ["욕", 4],
  ["용", 4],
  ["우", 15],
  ["운", 4],
  ["웅", 1],
  ["원", 11],
  ["월", 2],
  ["위", 14],
  ["유", 19],
  ["육", 2],
  ["윤", 2],
  ["은", 3],
  ["을", 1],
  ["음", 5],
  ["읍", 2],
  ["응", 2],
  ["의", 10],
  ["이", 8],
  ["익", 2],
  ["인", 9],
  ["일", 3],
  ["임", 3],
  ["입", 1],
  ["자", 12],
  ["작", 4],
  ["잔", 1],
  ["잠", 2],
  ["잡", 1],
  ["장", 19],
  ["재", 11],
  ["쟁", 1],
  ["저", 5],
  ["적", 12],
  ["전", 12],
  ["절", 5],
  ["점", 4],
  ["접", 2],
  ["정", 19],
  ["제", 14],
  ["조", 16],
  ["족", 2],
  ["존", 2],
  ["졸", 2],
  ["종", 6],
  ["좌", 4],
  ["죄", 1],
  ["주", 17],
  ["죽", 1],
  ["준", 3],
  ["중", 4],
  ["즉", 1],
  ["증", 7],
  ["지", 16],
  ["직", 3],
  ["진", 10],
  ["질", 4],
  ["집", 2],
  ["징", 2],
  ["차", 5],
  ["착", 3],
  ["찬", 2],
  ["찰", 1],
  ["참", 3],
  ["창", 7],
  ["채", 4],
  ["책", 3],
  ["처", 2],
  ["척", 4],
  ["천", 9],
  ["철", 3],
  ["첨", 2],
  ["첩", 1],
  ["청", 6],
  ["체", 5],
  ["초", 8],
  ["촉", 3],
  ["촌", 2],
  ["총", 3],
  ["최", 2],
  ["추", 5],
  ["축", 7],
  ["춘", 1],
  ["출", 1],
  ["충", 4],
  ["취", 6],
  ["측", 2],
  ["층", 1],
  ["치", 6],
  ["칙", 1],
  ["친", 1],
  ["칠", 2],
  ["침", 6],
  ["칭", 1],
  ["쾌", 1],
  ["타", 4],
  ["탁", 4],
  ["탄", 4],
  ["탈", 2],
  ["탐", 2],
  ["탑", 1],
  ["탕", 1],
  ["태", 5],
  ["택", 3],
  ["토", 3],
  ["통", 3],
  ["퇴", 1],
  ["투", 3],
  ["특", 1],
  ["파", 7],
  ["판", 4],
  ["팔", 1],
  ["패", 2],
  ["편", 6],
  ["평", 2],
  ["폐", 6],
  ["포", 7],
  ["폭", 3],
  ["표", 4],
  ["품", 1],
  ["풍", 2],
  ["피", 5],
  ["필", 4],
  ["하", 6],
  ["학", 2],
  ["한", 8],
  ["할", 1],
  ["함", 3],
  ["합", 1],
  ["항", 6],
  ["해", 6],
  ["핵", 1],
  ["행", 2],
  ["향", 5],
  ["허", 2],
  ["헌", 3],
  ["험", 2],
  ["혁", 1],
  ["현", 7],
  ["혈", 2],
  ["혐", 1],
  ["협", 2],
  ["형", 6],
  ["혜", 3],
  ["호", 13],
  ["혹", 2],
  ["혼", 4],
  ["홀", 1],
  ["홍", 4],
  ["화", 10],
  ["확", 3],
  ["환", 6],
  ["활", 1],
  ["황", 4],
  ["회", 4],
  ["획", 2],
  ["횡", 1],
  ["효", 3],
  ["후", 4],
  ["훈", 1],
  ["훼", 1],
  ["휘", 2],
  ["휴", 2],
  ["흉", 2],
  ["흑", 1],
  ["흡", 1],
  ["흥", 1],
  ["희", 4],
];

//  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8
// ㄱㄲㄴㄷㄸㄹㅁㅂㅃㅅㅆㅇㅈㅉㅊㅋㅌㅍㅎ
// length: 19

//  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0
// ㅏㅐㅑㅒㅓㅔㅕㅖㅗㅘㅙㅚㅛㅜㅝㅞㅟㅠㅡㅢㅣ
// length: 21

//  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7
//   ㄱㄲㄳㄴㄵㄶㄷㄹㄺㄻㄼㄽㄾㄿㅀㅁㅂㅄㅅㅆㅇㅈㅊㅋㅌㅍㅎ
// length: 28

function disassembleHangul(string: string, at: number) {
  const offsetko = (string.codePointAt(at) || 0) - 0xac00;
  return [
    Math.floor(offsetko / (21 * 28)),
    Math.floor((offsetko / 28) % 21),
    offsetko % 28,
  ] as const;
}

function assembleHangul([cheot, ga, ggeut]: [number, number, number]) {
  cheot = Math.min(Math.max(0, cheot), 18);
  ga = Math.min(Math.max(0, ga), 20);
  ggeut = Math.min(Math.max(0, ggeut), 27);
  return String.fromCodePoint(0xac00 + cheot * 21 * 28 + ga * 28 + ggeut);
}

const postprocess = (word: string) => {
  const de = disassembleHangul(word, 0);
  if (de[0] !== 2 && de[0] !== 5) return word;
  if ([6, 12, 17, 20].includes(de[1])) {
    return `${assembleHangul([11, de[1], de[2]])}${word.substring(1)}`;
  }
  if (de[0] !== 5) return word;

  if ([2, 7].includes(de[1])) {
    return `${assembleHangul([11, de[1], de[2]])}${word.substring(1)}`;
  }
  return `${assembleHangul([2, de[1], de[2]])}${word.substring(1)}`;
};

export const randomHanjaeo = (prng: () => number) => {
  const length = Math.min(Math.max(1, Math.round(randNorm(prng, 2, 2))), 5);
  const word = Array.from({ length }, () =>
    sampleByWeights(prng, hanjaeum),
  ).join("");
  const postprocessed = postprocess(word);
  return postprocessed;
};
